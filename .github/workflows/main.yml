name: Download and Restream MP4 File

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'URL of the MP4 file'
        required: true
        default: 'https://file-examples.com/storage/fe91352fe66730de9982024/2017/04/file_example_MP4_480_1_5MG.mp4'
      timeout:
        description: 'Timeout duration (not used in this workflow)'
        required: true
        default: '3h'
      bitrate:
        description: 'Desired bitrate (e.g., 800k for 800 kb/s)'
        required: false
        default: '800k'
      resolution:
        description: 'Desired resolution (e.g., 1280x720)'
        required: false
        default: 'res:1280'

jobs:
  download:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Install FFmpeg
      run: sudo apt-get update && sudo apt-get install -y ffmpeg

    - name: Download MP4 file
      run: |
        curl -L -o input.mp4 "${{ github.event.inputs.file_url }}"

    - name: Restream with FFmpeg
      run: |
        VBR="${{ github.event.inputs.bitrate }}"
        FPS="30"
        QUAL="medium"
        YOUTUBE_URL="rtmp://a.rtmp.youtube.com/live2"
        KEY="h40p-p7kj-w4te-pd1h-1f7w"
        RESOLUTION="${{ github.event.inputs.resolution }}"

        ffmpeg -re -i input.mp4 \
               -vcodec libx264 -pix_fmt yuv420p -preset $QUAL -r $FPS -g $((FPS * 2)) -b:v $VBR \
               -acodec aac -ar 44100 -threads 6 -b:a 128k -bufsize 512k \
               ${RESOLUTION:+ -vf "scale=${RESOLUTION##*:}:-1"} \
               -f flv "$YOUTUBE_URL/$KEY"
